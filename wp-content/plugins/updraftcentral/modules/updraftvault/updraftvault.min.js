function UpdraftCentral_PrevNext_Paginator(e,r,t){var a=this,n=t,i="",l=r.last_marker;function p(){a.element.trigger("page_change",i,l),"function"==typeof n&&n(i,l)}r.is_paged&&(0<r.prev_key.length||0<r.next_key.length)&&(t=e,a.element=jQuery(UpdraftCentral.template_replace("updraftvault-prevnext-paginator",{})),0==r.prev_key.length&&(a.element.find("a.page_prev").parent("li").hide(),a.element.find('li:contains("|")').hide()),0==r.next_key.length&&(a.element.find("a.page_next").parent("li").hide(),a.element.find('li:contains("|")').hide()),a.element.appendTo(t),a.element.on("click","a",function(e){e.preventDefault(),jQuery(this).hasClass("page_prev")?(markers=l.split(","),i=markers[markers.length-1],l=l.replace(","+i,""),p()):jQuery(this).hasClass("page_next")&&(i=r.next_key,l+=","+r.prev_key,p())})),this.page_change=function(e){n=e}}function UpdraftCentral_UpdraftVault_Management(){var o,n,i,l=this;function p(t,e){var r,a=t.find(".updraftcentral_updraftvault_paginator");0===a.length?(r=t.find(".updraftcentral_row_extracontents"),a=jQuery('<div class="updraftcentral_updraftvault_paginator"></div>').appendTo(r)):a.empty(),new UpdraftCentral_PrevNext_Paginator(a,e).page_change(function(e,r){e={bucket:n,prefix:i,marker_key:e,last_marker:r,per_page:t.find(".updraftcentral_updraftvault_header .per_page").val()};l.browse_files(t,e).then(function(e){void 0!==e.paging&&p(t,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})})}function s(e){UpdraftCentral.set_loading(e.container),void 0!==e.aws_request&&e.container.before('<div class="updraftcentral_spinner"></div>')}function d(e){var r=jQuery.Deferred();return UpdraftCentral.done_loading(e.container,e.html).then(function(){void 0!==e.aws_request&&e.container.parent().children(".updraftcentral_spinner").remove(),r.resolve()}),r.promise()}function u(e){var r;if("string"!=typeof e&&e&&e.hasOwnProperty("values")&&(r=e.values,e=e.message),void 0===e&&console.log("UpdraftCentral: The 'translate_message' requires an object with the properties 'message' and 'values' if there's a variable"),!1===e)return"";var t=udclion.updraftvault[e];return void 0===t?(UpdraftCentral_Library.dialog.alert("<h2>"+udclion.error+"</h2><p>"+sprintf(udclion.updraftvault.translation_not_found_for,e)+"</p>"),null):void 0===r?t:sprintf(t,r)}jQuery("#updraftcentral_dashboard_existingsites").on("updraftcentral_dashboard_mode_set_updraftvault",function(){UpdraftCentral.register_row_clicker('.updraftcentral_updraftvault_table input[name="uc_updraftvault_check_all"]',function(e){var r=!1;jQuery(this).is(":checked")&&(r=!0),e.find(".updraftcentral_updraftvault_table input.check_item").each(function(){jQuery(this).prop("checked",r)})},!0,"change"),UpdraftCentral.register_row_clicker("select.per_page",function(r){if(r.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;var e={bucket:n,prefix:i,per_page:r.find(".updraftcentral_updraftvault_header .per_page").val()};l.browse_files(r,e).then(function(e){void 0!==e.paging&&p(r,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})},!0,"change"),UpdraftCentral.register_row_clicker(".updraftcentral_site_updraftvault_action_btn",function(r){if(r.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;var t;"delete"===jQuery(this).data("action")&&(t={bucket:n,prefix:i,files:[]},r.find(".updraftcentral_updraftvault_table input.check_item:checked").each(function(){t.files.push(jQuery(this).data("key"))}),0<t.files.length?UpdraftCentral_Library.dialog.confirm("<h2>"+u("delete_files")+"</h2><p>"+u("delete_files_confirm")+"</p>",function(e){e&&l.delete_files(r,t)}):UpdraftCentral_Library.dialog.alert("<h2>"+u("empty_selection_header")+"</h2><p>"+u("select_files")+"</p>"))},!0),UpdraftCentral.register_row_clicker(".updraftcentral_site_browse_files",function(t){l.get_updraftvault_credentials(t).then(function(e){var r=function(e,r){var t={bucket:"",prefix:"",region:""};{var a;void 0===e||(a=e.split("/")).length&&(t.bucket=a[0],t.region=t.bucket.replace(r+"-",""),1<a.length&&(t.prefix=e.replace(t.bucket+"/","")+"/"))}return t}(e.path,e.key),e=(AWS.config.update({accessKeyId:e.accesskey,secretAccessKey:e.secretkey,sessionToken:e.sessiontoken}),AWS.config.region=r.region,o=new AWS.S3,n=r.bucket,i=r.prefix,{bucket:r.bucket,prefix:r.prefix,per_page:10,marker_key:"",last_marker:""});l.get_updraftvault_filters(t),l.browse_files(t,e).then(function(e){void 0!==e.paging&&p(t,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})})},!0)}),this.browse_files=function(e,r){var t=jQuery.Deferred(),e=e.find(".updraftcentral_row_extracontents"),a=e.find(".updraftcentral_updraftvault_rows"),n={container:a=0===a.length?jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(e):a,html:"",aws_request:!0};return s(n),function(f){var _=jQuery.Deferred();void 0===f.per_page&&(f.per_page=10);void 0===f.marker_key&&(f.marker_key="");void 0===f.last_marker&&(f.last_marker="");var e={Bucket:f.bucket,Delimiter:"/",Marker:f.marker_key,MaxKeys:f.per_page,Prefix:f.prefix};return o.listObjects(e,function(e,r){if(e)_.reject({error:!0,message:"general_error_response",values:[e.stack]});else{for(var t,a,n,i,e=f.marker_key,l="",u=!0,p=[],s=r.Contents,d=0;d<s.length;d++)a=(t=s[d].Key).replace(f.prefix,""),n=function(e,r){if(0===e)return"0 Bytes";var r=r||3,t=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,t)).toFixed(r))+" "+["Bytes","KB","MB","GB","TB"][t]}(s[d].Size,2),i={Bucket:f.bucket,Key:t},f.prefix!==t&&p.push({key:t,file_name:a,size:n,download_link:o.getSignedUrl("getObject",i)});p.length&&(r.IsTruncated?l=r.NextMarker:0===e.length&&(u=!1)),e={prev_key:e,next_key:l,is_paged:u,last_marker:f.last_marker},p.length?_.resolve({files:p,data:r,paging:e}):_.resolve({error:!1,message:"files_not_found",values:[]})}}),_.promise()}(r).then(function(e){n.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e),void 0!==e.message&&(n.html=u(e)),n.response=e}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+u("browse_failed_header")+"</h2><p>"+u(e)+"</p>"),n.response=e}).always(function(e){void 0===e&&(e=n.response),d(n).then(function(){void 0!==e.files?Array.isArray(e.files)&&jQuery(".updraftcentral_updraftvault_rows").removeClass("no-matched"):void 0!==e.message&&"files_not_found"===e.message&&jQuery(".updraftcentral_updraftvault_rows").addClass("no-matched"),t.resolve(e)})}),t.promise()},this.delete_files=function(t,a){var e=t.find(".updraftcentral_row_extracontents"),r=e.find(".updraftcentral_updraftvault_rows"),n={container:r=0===r.length?jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(e):r,html:"",aws_request:!0};s(n),function(e){var t=jQuery.Deferred();files=[];for(var r=0;r<e.files.length;r++)key=e.files[r],files.push({Key:key});var a={Bucket:e.bucket,Delete:{Objects:files}};return o.deleteObjects(a,function(e,r){e?t.reject({error:!0,message:"delete_error",values:[e.stack]}):t.resolve({error:!1,message:"delete_success",values:[]})}),t.promise()}(a).then(function(e){var r=e;l.browse_files(t,a).then(function(e){void 0!==e.paging&&p(t,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker}),UpdraftCentral_Library.dialog.alert("<h2>"+u("delete_success_header")+"</h2><p>"+u(r)+"</p>")})}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+u("delete_failed_header")+"</h2><p>"+u(e)+"</p>"),d(n)})},this.get_updraftvault_filters=function(e){var r=jQuery.Deferred(),e=e.find(".updraftcentral_row_extracontents"),t=e.find(".updraftcentral_updraftvault_filters"),e={container:t=0===t.length?jQuery('<div class="updraftcentral_updraftvault_filters"></div>').prependTo(e):t,html:""};s(e);return e.html=UpdraftCentral.template_replace("updraftvault-updraftvault-filter",{paging:{per_page_options:[10,20,50,100,500,1e3]}}),d(e).then(function(){r.resolve()}),r.promise()},this.get_updraftvault_credentials=function(e){var t=jQuery.Deferred(),r=e.find(".updraftcentral_row_extracontents"),a=r.find(".updraftcentral_updraftvault_rows"),n={container:a=0===a.length?jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(r):a,html:""};return s(n),UpdraftCentral.send_site_rpc("updraftvault.get_credentials",null,e,function(e,r){"ok"!==r||e.data.error?(UpdraftCentral_Library.dialog.alert("<h2>"+u("connection_error_header")+"</h2><p>"+u(e.data)+"</p>"),d(n),t.reject()):(n.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e.data),d(n).then(function(){t.resolve(e.data)}))}),t.promise()}}jQuery(function(){new UpdraftCentral_UpdraftVault_Management});