(function(t){function e(t){return"[id="+t.attr("id")+"][name="+t.attr("name")+"]"}t.fn.sisyphus=function(i){var n=t.map(this,(function(i){return e(t(i))})).join(),o=Sisyphus.getInstance(n);return o.protect(this,i),o};var i={isAvailable:function(){if("object"===typeof t.jStorage)return!0;try{return localStorage.getItem}catch(e){return!1}},set:function(e,i){if("object"===typeof t.jStorage)t.jStorage.set(e,i+"");else try{localStorage.setItem(e,i+"")}catch(n){}},get:function(e){if("object"===typeof t.jStorage){var i=t.jStorage.get(e);return i?i.toString():i}return localStorage.getItem(e)},remove:function(e){"object"===typeof t.jStorage?t.jStorage.deleteKey(e):localStorage.removeItem(e)}};Sisyphus=function(){var n={instantiated:[],started:[]},o=window.CKEDITOR;function a(){return{setInstanceIdentifier:function(t){this.identifier=t},getInstanceIdentifier:function(){return this.identifier},setInitialOptions:function(e){var n={excludeFields:[],customKeySuffix:"",locationBased:!1,timeout:0,autoRelease:!0,onBeforeSave:function(){},onSave:function(){},onBeforeRestore:function(){},onRestore:function(){},onRelease:function(){}};this.options=this.options||t.extend(n,e),this.browserStorage=i},setOptions:function(e){this.options=this.options||this.setInitialOptions(e),this.options=t.extend(this.options,e)},protect:function(e,i){this.setOptions(i),e=e||{};var a=this;if(this.targets=this.targets||[],a.options.name?this.href=a.options.name:this.href=location.hostname+location.pathname+location.search+location.hash,this.targets=t.merge(this.targets,e),this.targets=t.unique(this.targets),this.targets=t(this.targets),!this.browserStorage.isAvailable())return!1;var s=a.options.onBeforeRestore.call(a);if((void 0===s||s)&&a.restoreAllData(),this.options.autoRelease&&a.bindReleaseData(),!n.started[this.getInstanceIdentifier()])if(a.isCKEditorPresent())var r=setInterval((function(){o.isLoaded&&(clearInterval(r),a.bindSaveData(),n.started[a.getInstanceIdentifier()]=!0)}),100);else a.bindSaveData(),n.started[a.getInstanceIdentifier()]=!0},isCKEditorPresent:function(){return!!this.isCKEditorExists()&&(o.isLoaded=!1,o.on("instanceReady",(function(){o.isLoaded=!0})),!0)},isCKEditorExists:function(){return"undefined"!==typeof o},findFieldsToProtect:function(t){return t.find(":input").not(":submit").not(":reset").not(":button").not(":file").not(":password").not(":disabled").not("[readonly]")},bindSaveData:function(){var i=this;i.options.timeout&&i.saveDataByTimeout(),i.targets.each((function(){var n=e(t(this));i.findFieldsToProtect(t(this)).each((function(){if(-1!==t.inArray(this,i.options.excludeFields))return!0;var o=t(this),a=(i.options.locationBased?i.href:"")+n+e(o)+i.options.customKeySuffix;(o.is(":text")||o.is("textarea"))&&(i.options.timeout||i.bindSaveDataImmediately(o,a)),i.bindSaveDataOnChange(o)}))}))},saveAllData:function(){var i=this;i.targets.each((function(){var n=e(t(this)),a={};i.findFieldsToProtect(t(this)).each((function(){var s=t(this);if(-1!==t.inArray(this,i.options.excludeFields)||void 0===s.attr("name")&&void 0===s.attr("id"))return!0;var r=(i.options.locationBased?i.href:"")+n+e(s)+i.options.customKeySuffix,c=s.val();if(s.is(":checkbox")){var u=s.attr("name");if(void 0!==u&&-1!==u.indexOf("[")){if(!0===a[u])return;c=[],t("[name='"+u+"']:checked").each((function(){c.push(t(this).val())})),a[u]=!0}else c=s.is(":checked");i.saveToBrowserStorage(r,c,!1)}else if(s.is(":radio"))s.is(":checked")?(c=s.val(),i.saveToBrowserStorage(r,c,!1)):i.browserStorage.remove(r);else if(i.isCKEditorExists()){var f=o.instances[s.attr("name")]||o.instances[s.attr("id")];f?(f.updateElement(),i.saveToBrowserStorage(r,s.val(),!1)):i.saveToBrowserStorage(r,c,!1)}else i.saveToBrowserStorage(r,c,!1)}))})),i.options.onSave.call(i)},restoreAllData:function(){var i=this,n=!1;i.targets.each((function(){var o=t(this),a=e(t(this));i.findFieldsToProtect(o).each((function(){if(-1!==t.inArray(this,i.options.excludeFields))return!0;var o=t(this),s=(i.options.locationBased?i.href:"")+a+e(o)+i.options.customKeySuffix,r=i.browserStorage.get(s);null!==r&&(i.restoreFieldsData(o,r),n=!0)}))})),n&&i.options.onRestore.call(i)},restoreFieldsData:function(t,e){if(void 0===t.attr("name")&&void 0===t.attr("id"))return!1;var i=t.attr("name");!t.is(":checkbox")||"false"===e||void 0!==i&&-1!==i.indexOf("[")?!t.is(":checkbox")||"false"!==e||void 0!==i&&-1!==i.indexOf("[")?t.is(":radio")?t.val()===e&&t.prop("checked",!0):(void 0===i||-1===i.indexOf("[")||(e=e.split(",")),t.val(e)):t.prop("checked",!1):t.prop("checked",!0)},bindSaveDataImmediately:function(t,e){var i=this;if("onpropertychange"in t?t.get(0).onpropertychange=function(){i.saveToBrowserStorage(e,t.val())}:t.get(0).oninput=function(){i.saveToBrowserStorage(e,t.val())},this.isCKEditorExists()){var n=o.instances[t.attr("name")]||o.instances[t.attr("id")];n&&n.document.on("keyup",(function(){n.updateElement(),i.saveToBrowserStorage(e,t.val())}))}},saveToBrowserStorage:function(t,e,i){var n=this,o=n.options.onBeforeSave.call(n);void 0!==o&&!1===o||(i=void 0===i||i,this.browserStorage.set(t,e),i&&""!==e&&this.options.onSave.call(this))},bindSaveDataOnChange:function(t){var e=this;t.change((function(){e.saveAllData()}))},saveDataByTimeout:function(){var t=this;t.targets;setTimeout(function(){function e(){t.saveAllData(),setTimeout(e,1e3*t.options.timeout)}return e}(),1e3*t.options.timeout)},bindReleaseData:function(){var i=this;i.targets.each((function(){var n=t(this),o=e(n);t(this).bind("submit reset",(function(){i.releaseData(o,i.findFieldsToProtect(n))}))}))},manuallyReleaseData:function(){var i=this;i.targets.each((function(){var n=t(this),o=e(n);i.releaseData(o,i.findFieldsToProtect(n))}))},releaseData:function(i,o){var a=!1,s=this;n.started[s.getInstanceIdentifier()]=!1,o.each((function(){if(-1!==t.inArray(this,s.options.excludeFields))return!0;var n=t(this),o=(s.options.locationBased?s.href:"")+i+e(n)+s.options.customKeySuffix;s.browserStorage.remove(o),a=!0})),a&&s.options.onRelease.call(s)}}}return{getInstance:function(t){return n.instantiated[t]||(n.instantiated[t]=a(),n.instantiated[t].setInstanceIdentifier(t),n.instantiated[t].setInitialOptions()),n.instantiated[t]},free:function(){return n={instantiated:[],started:[]},null},version:"1.1.3"}}()})(jQuery);